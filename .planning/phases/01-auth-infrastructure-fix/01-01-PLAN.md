---
phase: 01-auth-infrastructure-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/middleware.ts
  - apps/web/lib/supabase/server.ts
autonomous: true

must_haves:
  truths:
    - "Middleware refreshes Supabase tokens on every request"
    - "Server client properly handles async cookies"
    - "Deprecated auth-helpers-nextjs package is removed"
  artifacts:
    - path: "apps/web/middleware.ts"
      provides: "Token refresh middleware at app root"
      contains: "createServerClient"
    - path: "apps/web/lib/supabase/server.ts"
      provides: "Server-side Supabase client"
      exports: ["createClient"]
  key_links:
    - from: "apps/web/middleware.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "import.*createServerClient.*@supabase/ssr"
---

<objective>
Create minimal token-refresh middleware and remove deprecated package.

Purpose: Enable session token refresh without redirect logic (avoids redirect loops). Remove deprecated `@supabase/auth-helpers-nextjs` that conflicts with `@supabase/ssr`.

Output: Working middleware.ts that refreshes tokens, cleaned package.json without deprecated package.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-infrastructure-fix/01-RESEARCH.md

Reference:
@apps/web/lib/supabase/middleware.ts (existing updateSession function - DO NOT USE as-is, too complex)
@apps/web/lib/supabase/server.ts (current server client)
@apps/web/package.json (has deprecated package)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove deprecated @supabase/auth-helpers-nextjs package</name>
  <files>apps/web/package.json, apps/web/lib/artifact/artifact-persistence.ts</files>
  <action>
1. Remove `@supabase/auth-helpers-nextjs` from dependencies in package.json

2. Update the ONE production file that uses the deprecated package:
   - File: `apps/web/lib/artifact/artifact-persistence.ts` (line 7)
   - Change: `import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'`
   - To: `import { createBrowserClient } from '@supabase/ssr'`
   - Also update usage: `createClientComponentClient()` -> `createBrowserClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!)`

3. Run `npm install` to update lockfile

Note: Test files also import this package for mocking - leave those as-is since they mock the module.
  </action>
  <verify>
- `npm run build` completes without errors about missing module
- `grep -r "auth-helpers-nextjs" apps/web/` returns no matches (excluding node_modules)
- Package.json no longer contains `@supabase/auth-helpers-nextjs`
  </verify>
  <done>
- Deprecated package removed from package.json
- No imports reference the deprecated package
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create minimal token-refresh middleware</name>
  <files>apps/web/middleware.ts</files>
  <action>
Create `apps/web/middleware.ts` at the app root (NOT in lib/supabase/).

This middleware ONLY refreshes tokens. No redirects, no route protection.

```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  let supabaseResponse = NextResponse.next({ request })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({ request })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT: getUser() validates JWT and refreshes if needed
  // Do NOT use getSession() - it only validates locally
  await supabase.auth.getUser()

  return supabaseResponse
}

export const config = {
  matcher: [
    // Match all paths except static files and images
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

CRITICAL: This middleware does ZERO redirects. All route protection is in API routes.
  </action>
  <verify>
- File exists at `apps/web/middleware.ts`
- `npm run build` succeeds
- `npm run dev` starts without middleware errors
- Visiting any page doesn't cause redirect loops
  </verify>
  <done>
- middleware.ts exists at app root
- Middleware uses getUser() (not getSession())
- No redirect logic in middleware
- Build and dev server work
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. `npm run dev` starts without errors
3. No import errors for removed package
4. Middleware file exists at correct location
5. Visiting localhost:3000 shows landing page (no redirect loop)
</verification>

<success_criteria>
- Deprecated package completely removed
- All imports updated to @supabase/ssr equivalents
- Minimal middleware refreshes tokens without redirects
- Development server runs without auth-related errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-infrastructure-fix/01-01-SUMMARY.md`
</output>
