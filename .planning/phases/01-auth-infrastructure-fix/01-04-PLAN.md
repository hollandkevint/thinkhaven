---
phase: 01-auth-infrastructure-fix
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can log in with email/password and stay logged in across refresh"
    - "User can log in with Google OAuth and access /app"
    - "User can log out from any page"
    - "No session expired errors during normal usage"
  artifacts: []
  key_links: []
---

<objective>
Verify all auth flows work end-to-end after infrastructure fixes.

Purpose: Confirm the auth fixes actually work for real users. This is the validation gate before marking AUTH-01 through AUTH-07 complete.

Output: Confirmation that all auth requirements pass manual testing.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-auth-infrastructure-fix/01-01-SUMMARY.md
@.planning/phases/01-auth-infrastructure-fix/01-02-SUMMARY.md
@.planning/phases/01-auth-infrastructure-fix/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start dev server and verify no startup errors</name>
  <files>N/A</files>
  <action>
1. Start dev server: `cd apps/web && npm run dev`
2. Watch console output for errors
3. Verify middleware loads without errors
4. Check that landing page loads at localhost:3000

Expected: Server starts cleanly, no middleware errors, landing page renders.
  </action>
  <verify>
- Dev server running on port 3000
- No red error text in console
- Landing page accessible at localhost:3000
  </verify>
  <done>
- Dev server starts cleanly
- No middleware or auth errors in startup
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth infrastructure: middleware token refresh, OAuth callback fix, getUser() security hardening</what-built>
  <how-to-verify>
Test each auth flow manually:

**TEST 1: Email/Password Login (AUTH-05)**
1. Go to http://localhost:3000/login
2. Enter valid test credentials
3. Click "Sign In"
4. Should land on /app (dashboard)
5. Refresh page - should stay logged in
6. Close browser, reopen, go to /app - should still be logged in (if within session TTL)

**TEST 2: Google OAuth Login (AUTH-06)**
1. Go to http://localhost:3000/login
2. Click "Sign in with Google"
3. Complete Google auth flow
4. Should redirect back to /app (NOT /dashboard)
5. Refresh page - should stay logged in

**TEST 3: Logout (AUTH-07)**
1. While logged in, find logout button (usually in header or settings)
2. Click logout
3. Should redirect to landing page or /login
4. Try navigating to /app - should redirect to login

**TEST 4: Session Persistence**
1. Log in with either method
2. Use the app for a few minutes
3. Refresh multiple times
4. Navigate between /app, /app/new, /app/session/[id]
5. Should NOT see "session expired" errors
6. Should remain logged in throughout

**Expected Results:**
- All 4 tests pass
- No redirect loops
- No blank screens
- No console errors about auth
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any failures with specific steps to reproduce</resume-signal>
</task>

</tasks>

<verification>
All 7 AUTH requirements verified:
- AUTH-01: Deprecated package removed (verified in Plan 01)
- AUTH-02: Minimal middleware created (verified in Plan 01)
- AUTH-03: getUser() used everywhere (verified in Plan 03)
- AUTH-04: OAuth redirects to /app (verified in Plan 02)
- AUTH-05: Email/password login works (verified in this plan)
- AUTH-06: OAuth login works (verified in this plan)
- AUTH-07: Logout works (verified in this plan)
</verification>

<success_criteria>
- All manual auth tests pass
- User explicitly approves the auth flows
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-infrastructure-fix/01-04-SUMMARY.md`
</output>
