---
phase: 01-auth-infrastructure-fix
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/app/api/credits/balance/route.ts
  - apps/web/app/api/checkout/idea-validation/route.ts
  - apps/web/app/api/feedback/trial/route.ts
  - apps/web/app/api/assessment/submit/route.ts
  - apps/web/lib/bmad/database.ts
  - apps/web/lib/bmad/session-primitives.ts
autonomous: true

must_haves:
  truths:
    - "API calls without valid auth return 401 Unauthorized"
    - "Expired or tampered tokens are rejected server-side"
    - "Authenticated API calls work correctly with valid sessions"
  artifacts:
    - path: "apps/web/app/api/credits/balance/route.ts"
      provides: "Credit balance API"
      contains: "getUser()"
  key_links:
    - from: "apps/web/app/api/**/route.ts"
      to: "supabase.auth.getUser"
      via: "authentication call"
      pattern: "supabase\\.auth\\.getUser\\(\\)"
---

<objective>
Replace getSession() with getUser() in all server-side auth checks.

Purpose: `getSession()` only validates JWT format locally - it doesn't verify with Supabase. `getUser()` makes a secure server call. Using getSession() is a security vulnerability.

Output: All API routes and server libs use getUser() for authentication.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-infrastructure-fix/01-01-SUMMARY.md

Note: Some files already use getUser() (chat/stream, bmad/route.ts). Focus on files that still use getSession().
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API routes to use getUser()</name>
  <files>apps/web/app/api/*/route.ts, apps/web/app/api/**/route.ts</files>
  <action>
First, run grep to identify files needing update:
```bash
grep -rn "getSession()" apps/web/app/api/ apps/web/lib/ --include="*.ts" | grep -v ".test."
```

Then, for each API route using getSession(), update to use getUser():

**Pattern to find:**
```typescript
const { data: { session } } = await supabase.auth.getSession()
if (!session) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
const user = session.user
```

**Replace with:**
```typescript
const { data: { user }, error: authError } = await supabase.auth.getUser()
if (authError || !user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}
```

Files likely needing update (verify with audit):
- apps/web/app/api/credits/balance/route.ts
- apps/web/app/api/checkout/idea-validation/route.ts
- apps/web/app/api/feedback/trial/route.ts
- apps/web/app/api/assessment/submit/route.ts

Files already correct (DO NOT CHANGE):
- apps/web/app/api/chat/stream/route.ts (already uses getUser on line 153)
- apps/web/app/api/bmad/route.ts (already uses getUser on lines 37, 188)
  </action>
  <verify>
- `grep -rn "getSession()" apps/web/app/api/ --include="*.ts" | grep -v ".test."` returns no matches
- `npm run build` succeeds
- API routes return 401 when not authenticated
  </verify>
  <done>
- All API routes use getUser()
- No getSession() in API routes
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update lib files to use getUser()</name>
  <files>apps/web/lib/**/*.ts</files>
  <action>
For each lib file using getSession() for authentication, update to getUser():

**Common patterns to update:**

1. Direct session checks:
```typescript
// OLD
const { data: { session } } = await supabase.auth.getSession()
// NEW
const { data: { user } } = await supabase.auth.getUser()
```

2. User extraction from session:
```typescript
// OLD
if (session?.user) { ... }
// NEW
if (user) { ... }
```

Files to check (from grep):
- apps/web/lib/bmad/database.ts
- apps/web/lib/bmad/session-primitives.ts
- apps/web/lib/ai/tools/session-tools.ts
- apps/web/lib/guest/session-store.ts
- apps/web/lib/guest/session-migration.ts

Skip files that use getSession() for non-auth purposes (e.g., reading session data vs authenticating).
  </action>
  <verify>
- `grep -rn "getSession()" apps/web/lib/ --include="*.ts" | grep -v ".test." | grep -v "// getSession"` returns minimal matches (only legitimate non-auth uses)
- `npm run build` succeeds
- No TypeScript errors about session vs user type
  </verify>
  <done>
- Lib files use getUser() for authentication
- Type errors resolved
- Build succeeds
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run lint` passes
3. Search for getSession shows only test files and non-auth usage
4. Manual API test: Call /api/credits/balance without auth header -> 401
</verification>

<success_criteria>
- All API routes authenticate with getUser()
- All lib authentication uses getUser()
- No security vulnerabilities from local-only JWT validation
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-infrastructure-fix/01-03-SUMMARY.md`
</output>
