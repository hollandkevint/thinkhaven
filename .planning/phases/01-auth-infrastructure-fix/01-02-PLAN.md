---
phase: 01-auth-infrastructure-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/web/app/auth/callback/route.ts
autonomous: true

must_haves:
  truths:
    - "OAuth callback redirects to /app not /dashboard"
    - "OAuth success logs user in and persists session"
    - "OAuth errors redirect to login with error message"
  artifacts:
    - path: "apps/web/app/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
      contains: "/app"
  key_links:
    - from: "apps/web/app/auth/callback/route.ts"
      to: "/app"
      via: "NextResponse.redirect"
      pattern: "redirect.*origin.*/app"
---

<objective>
Fix OAuth callback to redirect to /app instead of legacy /dashboard.

Purpose: OAuth users currently land on /dashboard (404 or wrong page) after login. Should redirect to /app (the actual dashboard).

Output: OAuth callback that properly redirects authenticated users to /app.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-infrastructure-fix/01-01-SUMMARY.md (from previous plan)

Reference:
@apps/web/app/auth/callback/route.ts (current callback - redirects to /dashboard on line 115)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update OAuth callback redirect destination</name>
  <files>apps/web/app/auth/callback/route.ts</files>
  <action>
Update the OAuth callback route to redirect to `/app` instead of `/dashboard`.

Find this line (around line 115):
```typescript
return NextResponse.redirect(`${requestUrl.origin}/dashboard`)
```

Replace with:
```typescript
return NextResponse.redirect(`${requestUrl.origin}/app`)
```

Also update the console.log on line 114:
```typescript
console.log('OAuth callback: Redirecting to app')
```

Do NOT change any other logic in this file. The error handling, logging, and session exchange are all correct.
  </action>
  <verify>
- File contains `/app` as redirect destination (not /dashboard)
- `grep -n "dashboard" apps/web/app/auth/callback/route.ts` returns no matches
- `npm run build` succeeds
  </verify>
  <done>
- OAuth callback redirects to /app on successful authentication
- No references to /dashboard in callback route
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Update remaining /dashboard references to /app</name>
  <files>apps/web/lib/supabase/middleware.ts, apps/web/app/try/page.tsx</files>
  <action>
Update the 3 remaining /dashboard references in production code:

1. `apps/web/lib/supabase/middleware.ts` (line 13):
   - Change: `request.nextUrl.pathname === '/dashboard'`
   - To: `request.nextUrl.pathname === '/app'`

2. `apps/web/lib/supabase/middleware.ts` (line 136):
   - Change: `url.pathname = redirectParam || '/dashboard'`
   - To: `url.pathname = redirectParam || '/app'`

3. `apps/web/app/try/page.tsx` (line 38):
   - Change: `router.push('/dashboard')`
   - To: `router.push('/app')`

Note: Test files have /dashboard references - leave those as-is since they test legacy redirect behavior.
  </action>
  <verify>
- `grep -rn "/dashboard" apps/web/app apps/web/lib --include="*.ts" --include="*.tsx" | grep -v "tests/" | grep -v ".test."` returns no matches
- All auth success flows redirect to /app
- `npm run build` succeeds
  </verify>
  <done>
- All production auth-related redirects point to /app
- No functional code redirects to /dashboard
- OAuth flow works end-to-end (manual test)
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. OAuth callback file redirects to /app
3. No auth-related code redirects to /dashboard
4. Manual test: If you have Google OAuth configured, test the full flow:
   - Go to /login
   - Click "Sign in with Google"
   - After auth, should land on /app (not /dashboard)
</verification>

<success_criteria>
- OAuth callback redirects to /app
- All other auth flows redirect to /app
- No redirect loops
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-auth-infrastructure-fix/01-02-SUMMARY.md`
</output>
