---
phase: 02-beta-access-control
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified: []
autonomous: false

user_setup:
  - service: supabase
    why: "Enable Custom Access Token Hook in dashboard"
    dashboard_config:
      - task: "Enable Custom Access Token Hook"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Custom Access Token"
      - task: "Run migration 013_beta_access.sql"
        location: "Supabase Dashboard -> SQL Editor"
      - task: "Add SUPABASE_JWT_SECRET to Vercel"
        location: "Vercel Dashboard -> Project Settings -> Environment Variables"

must_haves:
  truths:
    - "Custom Access Token Hook is enabled in Supabase dashboard"
    - "Migration 013_beta_access.sql has been run"
    - "SUPABASE_JWT_SECRET is set in Vercel env vars"
    - "New user signup creates beta_access row automatically"
    - "Approved user can access /app/*, unapproved user sees /waitlist"
  artifacts: []
  key_links:
    - from: "Supabase Auth"
      to: "custom_access_token_hook function"
      via: "Auth Hooks configuration"
      pattern: "Hook enabled in dashboard"
---

<objective>
Enable the Custom Access Token Hook in Supabase dashboard, run the migration, configure environment variables, and verify the complete beta access flow works end-to-end.

Purpose: The code is complete but the hook must be enabled in Supabase dashboard (cannot be done via migration alone).
Output: Working beta access gate with verified approve/reject flow.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-beta-access-control/02-RESEARCH.md
@.planning/phases/02-beta-access-control/02-01-SUMMARY.md
@.planning/phases/02-beta-access-control/02-02-SUMMARY.md
@.planning/phases/02-beta-access-control/02-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Run migration and enable hook in Supabase</name>
  <action>
Human must complete these steps in Supabase Dashboard:

**Step 1: Run the migration**
1. Go to Supabase Dashboard -> SQL Editor
2. Copy contents of `apps/web/supabase/migrations/013_beta_access.sql`
3. Run the SQL
4. Verify: Run `SELECT * FROM public.beta_access;` (should return empty table)
5. Verify: Run `SELECT routine_name FROM information_schema.routines WHERE routine_name = 'custom_access_token_hook';` (should return 1 row)

**Step 2: Enable the Custom Access Token Hook**
1. Go to Supabase Dashboard -> Authentication -> Hooks
2. Find "Custom Access Token" section
3. Click "Create hook" or enable the hook
4. Set the function to: `public.custom_access_token_hook`
5. Save

**Step 3: Add SUPABASE_JWT_SECRET to Vercel (if not already set)**
1. Go to Supabase Dashboard -> Project Settings -> API
2. Copy the "JWT Secret" (under JWT Settings section)
3. Go to Vercel Dashboard -> thinkhaven project -> Settings -> Environment Variables
4. Add new variable:
   - Name: `SUPABASE_JWT_SECRET`
   - Value: (paste the JWT secret)
   - Environments: Production, Preview, Development
5. Redeploy to pick up new env var (or it will be used on next deploy)

**For local development:**
Add to `apps/web/.env.local`:
```
SUPABASE_JWT_SECRET=your-jwt-secret-here
```
  </action>
  <resume-signal>Type "done" when migration is run, hook is enabled, and JWT secret is configured</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete beta access flow</name>
  <what-built>
Complete beta access control system:
- beta_access table tracks signups and approvals
- Custom Access Token Hook injects beta_approved claim into JWT
- /app/* layout checks JWT and redirects unapproved users to /waitlist
- Landing page has waitlist signup form
- /waitlist shows pending message
  </what-built>
  <how-to-verify>
**Test 1: Waitlist signup (unauthenticated)**
1. Visit https://thinkhaven.co (or localhost:3000)
2. Find waitlist signup form
3. Enter a test email address
4. Submit
5. Expected: Success message "You're on the list!"
6. Verify: In Supabase Table Editor, check beta_access table has new row

**Test 2: Waitlist signup (duplicate)**
1. Submit the same email again
2. Expected: Message "You're already on the list!" (not an error)

**Test 3: New user signup -> waitlist flow**
1. Sign up with a new account (email/password or OAuth)
2. After signup, try to visit /app
3. Expected: Redirect to /waitlist page
4. Verify: beta_access row exists with user_id populated

**Test 4: Approve user -> access granted**
1. In Supabase Table Editor, find the test user's beta_access row
2. Set `approved_at` to `now()` and `approved_by` to your name
3. Save
4. LOG OUT of the app (this is required for JWT refresh)
5. Log back in
6. Try to visit /app
7. Expected: Access granted, dashboard loads

**Test 5: Edge case - direct URL access**
1. While logged in as unapproved user, try directly navigating to:
   - /app/session/test
   - /app/new
   - /app/account
2. Expected: All redirect to /waitlist

**Test 6: Logout and re-test**
1. Log out
2. Try to visit /app
3. Expected: Redirect to /login (not /waitlist)
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 tests pass, or describe which test failed</resume-signal>
</task>

</tasks>

<verification>
All verification happens in the human-verify checkpoint. The tests cover:
1. Waitlist form functionality
2. Duplicate handling
3. New user -> waitlist flow
4. Admin approval -> access granted
5. Protected route enforcement
6. Auth vs beta distinction (logged out vs unapproved)
</verification>

<success_criteria>
- Migration 013_beta_access.sql successfully run in Supabase
- Custom Access Token Hook enabled and pointing to custom_access_token_hook function
- SUPABASE_JWT_SECRET configured in Vercel env vars
- All 6 verification tests pass
- Unapproved user sees /waitlist, approved user sees /app
</success_criteria>

<output>
After completion, create `.planning/phases/02-beta-access-control/02-04-SUMMARY.md`
</output>
