---
phase: 02-beta-access-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/supabase/migrations/013_beta_access.sql
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "beta_access table exists in database with user_id, email, approved_at columns"
    - "custom_access_token_hook function exists and is granted to supabase_auth_admin"
    - "jose library is available for JWT verification"
  artifacts:
    - path: "apps/web/supabase/migrations/013_beta_access.sql"
      provides: "Beta access table, trigger, and custom access token hook"
      contains: "create table public.beta_access"
    - path: "apps/web/package.json"
      provides: "jose dependency"
      contains: '"jose"'
  key_links:
    - from: "custom_access_token_hook"
      to: "beta_access table"
      via: "SELECT query on user_id"
      pattern: "from public.beta_access"
---

<objective>
Create the database foundation for beta access control: the beta_access table to track waitlist signups and approval status, the trigger to auto-create entries on signup, and the Custom Access Token Hook function that injects beta_approved claim into JWTs.

Purpose: Without this foundation, there's no way to track who's approved or inject claims into JWTs.
Output: Migration file ready to run, jose library installed for JWT verification in later plans.
</objective>

<execution_context>
@/Users/kthkellogg/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kthkellogg/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-beta-access-control/02-RESEARCH.md
@apps/web/supabase/migrations/012_fix_message_limit_default.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create beta_access database migration</name>
  <files>apps/web/supabase/migrations/013_beta_access.sql</files>
  <action>
Create migration file with:

1. **beta_access table:**
   - id (uuid, primary key, default gen_random_uuid())
   - user_id (uuid, references auth.users(id) on delete cascade, unique)
   - email (text, not null)
   - created_at (timestamptz, default now(), not null)
   - approved_at (timestamptz, nullable — NULL = not approved, timestamp = approved)
   - approved_by (text, nullable — admin identifier for audit)
   - source (text, default 'landing_page' — 'landing_page', 'signup', 'manual', 'import')

2. **Indexes:**
   - idx_beta_access_user_id on (user_id)
   - idx_beta_access_email on (email)
   - idx_beta_access_approved on (approved_at) where approved_at is not null

3. **RLS policies:**
   - Enable RLS on table
   - "Users can view own beta_access" — SELECT using (auth.uid() = user_id)
   - "Anyone can join waitlist" — INSERT with check (true)
   - No UPDATE/DELETE policies (admin uses service role via Table Editor)

4. **Trigger for auto-create on signup:**
   - Function: handle_new_user_beta_access() — inserts into beta_access on auth.users insert
   - Uses ON CONFLICT (user_id) DO UPDATE to link existing waitlist entry to new user
   - Trigger: on_auth_user_created_beta after insert on auth.users

5. **Custom Access Token Hook function:**
   - Function: custom_access_token_hook(event jsonb) returns jsonb
   - Language: plpgsql, STABLE, SECURITY INVOKER
   - Logic: Look up user_id in beta_access, set claims.beta_approved = (approved_at is not null)
   - Default to false if no row found
   - GRANT EXECUTE to supabase_auth_admin
   - REVOKE EXECUTE from authenticated, anon, public
   - GRANT SELECT on beta_access to supabase_auth_admin

6. **Comments:**
   - Add descriptive comments on table and function for documentation

Reference the exact SQL patterns from 02-RESEARCH.md "Database Migration" section.
  </action>
  <verify>
File exists at apps/web/supabase/migrations/013_beta_access.sql and contains:
- CREATE TABLE public.beta_access
- CREATE FUNCTION public.custom_access_token_hook
- GRANT EXECUTE ON FUNCTION public.custom_access_token_hook TO supabase_auth_admin
- REVOKE EXECUTE ON FUNCTION public.custom_access_token_hook FROM authenticated, anon, public
  </verify>
  <done>Migration file is complete and syntactically valid SQL. Ready to be run in Supabase.</done>
</task>

<task type="auto">
  <name>Task 2: Install jose library for JWT verification</name>
  <files>apps/web/package.json</files>
  <action>
Run npm install to add jose library:

```bash
cd apps/web && npm install jose
```

jose is the standard library for JWT verification that works in Edge Runtime and server contexts. It's required for verifying JWT signatures and extracting the beta_approved claim in Plan 02.

Do NOT use jsonwebtoken (CommonJS issues with Edge Runtime).
  </action>
  <verify>
Run: `cd apps/web && npm list jose`
Should show jose@5.x.x (or higher) in the dependency tree.
Also verify package.json contains "jose" in dependencies.
  </verify>
  <done>jose library is installed and available for import in the codebase.</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls apps/web/supabase/migrations/013_beta_access.sql`
2. jose installed: `cd apps/web && npm list jose` shows version
3. Migration syntax valid: No obvious SQL errors (CREATE TABLE, FUNCTION, GRANT/REVOKE present)
</verification>

<success_criteria>
- Migration file 013_beta_access.sql exists with beta_access table, hook function, and security grants
- jose library appears in apps/web/package.json dependencies
- No duplicate or conflicting migrations (012 is latest before this)
</success_criteria>

<output>
After completion, create `.planning/phases/02-beta-access-control/02-01-SUMMARY.md`
</output>
